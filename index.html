<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #050712;
            --bg-secondary: rgba(13, 17, 23, 0.9);
            --bg-tertiary: rgba(22, 27, 34, 0.9);
            --bg-elevated: rgba(32, 38, 46, 0.96);
            --accent-primary: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
            --accent-cyan: #39c5cf;
            --accent-amber: #f2b236;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-tertiary: #6e7681;
            --border-default: #30363d;
            --border-muted: #21262d;
            --glass-border: rgba(255, 255, 255, 0.03);
            --glass-bg: rgba(7, 10, 18, 0.86);
            --glass-elevated-bg: rgba(10, 14, 22, 0.96);
            --shadow-soft: 0 14px 35px rgba(0, 0, 0, 0.55);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 14px; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background:
                radial-gradient(circle at 0% 0%, rgba(88, 166, 255, 0.14), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(163, 113, 247, 0.12), transparent 55%),
                radial-gradient(circle at 100% 0%, rgba(63, 185, 80, 0.08), transparent 55%),
                #02040a;
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            pointer-events: none;
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 160 160' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='noStitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.06'/%3E%3C/svg%3E");
            mix-blend-mode: soft-light;
            z-index: -1;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(10, 13, 20, 0.85); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #3b82f6, #6366f1); border-radius: 4px; }

        .app-container { max-width: 1600px; margin: 0 auto; padding: 24px; position: relative; }

        .top-gradient-bar {
            position: fixed; left: 0; top: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, rgba(88, 166, 255, 0.2), rgba(88, 166, 255, 0.7), rgba(163, 113, 247, 0.7), rgba(57, 197, 207, 0.7), rgba(63, 185, 80, 0.7), rgba(88, 166, 255, 0.2));
            background-size: 200% 100%;
            animation: pulse-bar 14s linear infinite;
            z-index: 999;
        }
        @keyframes pulse-bar { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }

        .nav-header {
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 28px; padding: 18px 22px; border-radius: 20px;
            background:
                radial-gradient(circle at 0% 0%, rgba(88, 166, 255, 0.12), transparent 60%),
                radial-gradient(circle at 100% 100%, rgba(163, 113, 247, 0.12), transparent 60%),
                rgba(10, 14, 22, 0.94);
            border: 1px solid rgba(88, 166, 255, 0.25);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7), 0 0 20px rgba(88, 166, 255, 0.2);
            position: relative; overflow: hidden;
        }
        .nav-header::after {
            content: "";
            position: absolute; inset: 0;
            background: radial-gradient(circle at 10% -10%, rgba(255, 255, 255, 0.1), transparent 60%);
            opacity: 0.6;
            pointer-events: none;
        }

        .logo-icon {
            width: 40px; height: 40px; border-radius: 14px;
            background: radial-gradient(circle at 30% 0%, #ffffff, #60a5fa);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 700; letter-spacing: 0.12em; color: #020617;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.65), 0 0 14px rgba(96, 165, 250, 0.55);
        }
        .logo-text {
            font-size: 1.3rem; font-weight: 700; letter-spacing: 0.22em; text-transform: uppercase;
            background: linear-gradient(120deg, #e5e7eb, #60a5fa, #a855f7);
            -webkit-background-clip: text; color: transparent;
        }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.22s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        .page-header { margin-bottom: 22px; padding: 10px 4px; text-align: center; }
        .page-title {
            font-size: 2rem; font-weight: 800; margin-bottom: 6px; letter-spacing: 0.18em; text-transform: uppercase;
            background: linear-gradient(110deg, #e5e7eb, #60a5fa, #a855f7);
            -webkit-background-clip: text; color: transparent;
        }
        .page-subtitle { color: var(--text-secondary); font-size: 0.9375rem; }

        .input-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; margin-bottom: 24px; }
        .input-full { grid-column: 1 / -1; }

        .card {
            background: var(--glass-bg); border-radius: 16px; border: 1px solid var(--glass-border);
            padding: 20px; box-shadow: var(--shadow-soft); backdrop-filter: blur(14px);
        }
        .results-card {
            background: var(--glass-elevated-bg); border-radius: 18px;
            border: 1px solid rgba(88, 166, 255, 0.16);
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.8), 0 0 20px rgba(88, 166, 255, 0.12);
            overflow: hidden; backdrop-filter: blur(18px);
        }

        .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
        .card-icon {
            width: 32px; height: 32px;
            background: radial-gradient(circle at 30% 0%, rgba(88, 166, 255, 0.2), rgba(22, 27, 34, 0.9));
            border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--accent-primary);
        }
        .card-title { font-size: 0.8125rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }

        .date-row-container { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
        .date-picker-row { display: flex; align-items: center; gap: 16px; }
        .date-picker-row label { font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; }

        .page-nav-tabs {
            display: flex; gap: 4px; background: rgba(20, 24, 32, 0.9); padding: 4px; border-radius: 999px;
            border: 1px solid rgba(88, 166, 255, 0.25); box-shadow: 0 0 14px rgba(88, 166, 255, 0.25);
        }
        .page-nav-tab {
            padding: 8px 16px; border-radius: 999px; border: none; background: transparent;
            color: var(--text-secondary); font-family: 'Inter', sans-serif; font-size: 0.8125rem;
            font-weight: 500; cursor: pointer; transition: all 0.18s ease-out;
        }
        .page-nav-tab:hover { color: var(--text-primary); background: rgba(88, 166, 255, 0.12); box-shadow: 0 0 10px rgba(88, 166, 255, 0.25); }
        .page-nav-tab.active { background: radial-gradient(circle at 30% 0, #58a6ff, #39c5cf); color: #fff; box-shadow: 0 0 16px rgba(88, 166, 255, 0.5); }

        input[type="date"] {
            font-family: 'JetBrains Mono', monospace; padding: 10px 14px;
            background: rgba(19, 24, 32, 0.95); border: 1px solid var(--border-default); border-radius: 10px;
            color: var(--text-primary); font-size: 0.875rem;
            transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out, background 0.15s ease-out;
        }
        input[type="date"]:focus {
            outline: none; border-color: var(--accent-primary); background: rgba(8, 12, 20, 0.95);
            box-shadow: 0 0 12px rgba(88, 166, 255, 0.4);
        }

        textarea {
            width: 100%; height: 140px; background: rgba(15, 19, 29, 0.96);
            border: 1px solid var(--border-default); border-radius: 12px; padding: 14px;
            color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem;
            resize: vertical; transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out, background 0.15s ease-out;
        }
        textarea:focus {
            outline: none; border-color: var(--accent-primary); background: rgba(8, 12, 20, 0.98);
            box-shadow: 0 0 14px rgba(88, 166, 255, 0.35);
        }
        textarea::placeholder { color: var(--text-tertiary); }

        .button-row { display: flex; gap: 10px; margin-bottom: 24px; flex-wrap: wrap; justify-content: center; }
        .btn {
            font-family: 'Inter', sans-serif; font-weight: 500; padding: 10px 18px; border-radius: 999px;
            border: 1px solid transparent; cursor: pointer; font-size: 0.875rem; transition: all 0.18s ease-out;
            display: inline-flex; align-items: center; gap: 8px; position: relative; overflow: hidden;
        }
        .btn svg { width: 16px; height: 16px; }
        .btn::after { content: ""; position: absolute; inset: 0; background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.14), transparent 60%); opacity: 0; transition: opacity 0.18s ease-out; pointer-events: none; }
        .btn:hover::after { opacity: 0.6; }

        .btn-primary { background: linear-gradient(135deg, #60a5fa, #38bdf8); color: #fff; box-shadow: 0 8px 20px rgba(37, 99, 235, 0.6), 0 0 14px rgba(56, 189, 248, 0.4); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 10px 26px rgba(37, 99, 235, 0.7), 0 0 18px rgba(56, 189, 248, 0.5); }
        .btn-secondary { background: rgba(22, 27, 34, 0.9); color: var(--text-primary); border-color: var(--border-default); box-shadow: 0 8px 22px rgba(0, 0, 0, 0.6); }
        .btn-secondary:hover { background: rgba(32, 38, 46, 0.98); box-shadow: 0 10px 26px rgba(0, 0, 0, 0.75); transform: translateY(-1px); }
        .btn-danger { background: transparent; color: var(--accent-red); border-color: var(--border-default); }
        .btn-danger:hover { background: rgba(248, 81, 73, 0.12); box-shadow: 0 0 12px rgba(248, 81, 73, 0.4); transform: translateY(-1px); }
        .btn-success { background: transparent; color: var(--accent-green); border-color: var(--border-default); }
        .btn-success:hover { background: rgba(63, 185, 80, 0.12); box-shadow: 0 0 12px rgba(63, 185, 80, 0.4); transform: translateY(-1px); }
        .btn-purple { background: linear-gradient(135deg, #a371f7, #8b5cf6); color: #fff; box-shadow: 0 8px 20px rgba(139, 92, 246, 0.5), 0 0 14px rgba(163, 113, 247, 0.4); }
        .btn-purple:hover { transform: translateY(-1px); box-shadow: 0 10px 26px rgba(139, 92, 246, 0.6), 0 0 18px rgba(163, 113, 247, 0.5); }

        .btn-small { padding: 6px 12px; font-size: 0.75rem; }
        .btn-retry { background: rgba(88, 166, 255, 0.15); color: var(--accent-primary); border: 1px solid rgba(88, 166, 255, 0.4); }
        .btn-retry:hover { background: rgba(88, 166, 255, 0.25); box-shadow: 0 0 10px rgba(88, 166, 255, 0.4); }

        .status-message {
            padding: 12px 16px; border-radius: 10px; margin-bottom: 20px; font-size: 0.875rem;
            display: none; border: 1px solid transparent; backdrop-filter: blur(10px);
            max-width: 520px; margin-left: auto; margin-right: auto;
        }
        .status-success { background: rgba(63, 185, 80, 0.1); border-color: rgba(63, 185, 80, 0.4); color: var(--accent-green); display: block; }
        .status-error { background: rgba(248, 81, 73, 0.12); border-color: rgba(248, 81, 73, 0.45); color: var(--accent-red); display: block; }
        .status-info { background: rgba(88, 166, 255, 0.12); border-color: rgba(88, 166, 255, 0.4); color: var(--accent-primary); display: block; }

        .results-header {
            display: flex; justify-content: space-between; align-items: center; padding: 16px 20px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.8);
            background: linear-gradient(135deg, rgba(19, 24, 32, 0.96), rgba(10, 14, 22, 0.96));
            backdrop-filter: blur(18px);
        }
        .results-title { font-size: 0.9375rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .results-count {
            background: rgba(25, 30, 40, 0.95); padding: 4px 10px; border-radius: 999px; font-size: 0.75rem; color: var(--text-secondary); border: 1px solid rgba(88, 166, 255, 0.35);
        }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
        thead { background: rgba(16, 21, 31, 0.98); position: sticky; top: 0; z-index: 10; backdrop-filter: blur(12px); }
        th {
            padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em; border-bottom: 1px solid rgba(48, 54, 61, 0.9); white-space: nowrap;
        }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border-muted); vertical-align: middle; }
        tbody tr {
            transition: filter 0.12s ease-out, transform 0.12s ease-out, box-shadow 0.12s ease-out;
            box-shadow: 0 0 0 rgba(0, 0, 0, 0);
        }
        tbody tr:hover {
            filter: brightness(1.06); transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.7), 0 0 10px rgba(88, 166, 255, 0.25);
        }

        .ticker-cell {
            font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-primary);
            cursor: pointer; position: relative; transition: color 0.15s ease-out, text-shadow 0.15s ease-out;
        }
        .ticker-cell:hover { color: var(--accent-cyan); text-shadow: 0 0 8px rgba(88, 166, 255, 0.65); }
        .ticker-cell::after { content: ' ›'; font-size: 0.75rem; opacity: 0.5; }
        .ticker-cell.expanded::after { content: ' ‹'; }

        .price-cell { font-family: 'JetBrains Mono', monospace; }
        .change-positive, .price-positive { color: var(--accent-green); font-weight: 600; }
        .change-negative, .price-negative { color: var(--accent-red); font-weight: 600; }

        .date-input {
            font-family: 'JetBrains Mono', monospace; padding: 6px 10px; background: rgba(19, 24, 32, 0.96);
            border: 1px solid var(--border-default); border-radius: 8px; color: var(--text-primary); font-size: 0.8125rem;
            transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out, background 0.15s ease-out;
        }
        .date-input:focus {
            outline: none; border-color: var(--accent-primary); background: rgba(8, 12, 20, 0.98);
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.4);
        }

        .price-input {
            font-family: 'JetBrains Mono', monospace; width: 85px; padding: 6px 10px; background: rgba(19, 24, 32, 0.96);
            border: 1px solid var(--border-default); border-radius: 8px; color: var(--text-primary); font-size: 0.8125rem;
            text-align: right; transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out, background 0.15s ease-out;
        }
        .price-input:focus {
            outline: none; border-color: var(--accent-primary); background: rgba(8, 12, 20, 0.98);
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.35);
        }

        .btn-remove {
            background: transparent; border: none; color: var(--text-tertiary); cursor: pointer;
            padding: 6px 8px; border-radius: 6px; opacity: 0.6;
            transition: background 0.15s ease-out, color 0.15s ease-out, opacity 0.15s ease-out;
        }
        .btn-remove:hover { background: rgba(248, 81, 73, 0.18); color: var(--accent-red); opacity: 1; }

        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-tertiary); }
        .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.4; }
        .empty-state p { max-width: 320px; margin: 0 auto; }

        .loading { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border-default); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .company-info-row td { padding: 0; }
        .company-info-content {
            padding: 20px 24px 18px;
            background:
                radial-gradient(circle at 0 0, rgba(88, 166, 255, 0.14), transparent 60%),
                radial-gradient(circle at 100% 100%, rgba(163, 113, 247, 0.14), transparent 60%),
                rgba(3, 7, 18, 0.98);
            backdrop-filter: blur(20px); border-radius: 18px;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.85), 0 0 18px rgba(88, 166, 255, 0.18);
        }
        .company-info-layout { display: grid; grid-template-rows: auto 1fr; gap: 16px; }

        .company-hero {
            display: flex; justify-content: space-between; align-items: center; padding: 12px 18px; border-radius: 14px;
            background:
                linear-gradient(120deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.96)),
                linear-gradient(120deg, rgba(88, 166, 255, 0.35), rgba(163, 113, 247, 0.45));
            border: 1px solid rgba(88, 166, 255, 0.4);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8), 0 0 16px rgba(88, 166, 255, 0.3);
            position: relative; overflow: hidden;
        }
        .company-hero::after {
            content: ""; position: absolute; inset: 0;
            background: radial-gradient(circle at 0% 0%, rgba(255, 255, 255, 0.1), transparent 55%);
            mix-blend-mode: soft-light; opacity: 0.7; pointer-events: none;
        }
        .company-hero-main { position: relative; z-index: 1; }
        .company-hero-ticker {
            font-family: 'JetBrains Mono', monospace; font-size: 1.05rem;
            letter-spacing: 0.18em; text-transform: uppercase; margin-bottom: 4px;
        }
        .company-hero-name { font-size: 0.9rem; color: var(--text-secondary); }

        .company-hero-meta { display: flex; flex-wrap: wrap; gap: 8px; position: relative; z-index: 1; }
        .company-hero-chip {
            padding: 4px 10px; border-radius: 999px; font-size: 0.7rem; letter-spacing: 0.05em;
            text-transform: uppercase; border: 1px solid rgba(148, 163, 184, 0.7);
            background: rgba(15, 23, 42, 0.72); color: #e5e7eb;
        }

        .company-panels { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 14px; }
        .company-panel {
            background: rgba(7, 11, 20, 0.96); border-radius: 14px; padding: 14px 14px 12px;
            border: 1px solid rgba(31, 41, 55, 0.9);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.85), 0 0 12px rgba(15, 23, 42, 0.7);
        }
        .company-panel h4 {
            font-size: 0.74rem; text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 6px;
        }
        .company-panel-snapshot h4, .company-panel-bottomline h4 { color: var(--accent-primary); }
        .company-panel p { color: var(--text-secondary); font-size: 0.84rem; line-height: 1.6; }
        .company-panel a { color: var(--accent-primary); text-decoration: none; font-size: 0.8rem; }

        .company-panel-score {
            display: flex; flex-direction: column; gap: 4px; align-items: flex-start; justify-content: center;
            background: radial-gradient(circle at 0 0, rgba(250, 204, 21, 0.13), rgba(15, 23, 42, 1));
            border-color: rgba(250, 204, 21, 0.7);
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.8), 0 0 14px rgba(250, 204, 21, 0.35);
        }
        .company-panel-score.verdict-yes {
            background: radial-gradient(circle at 0 0, rgba(63, 185, 80, 0.15), rgba(15, 23, 42, 1));
            border-color: rgba(63, 185, 80, 0.7);
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.8), 0 0 14px rgba(63, 185, 80, 0.35);
        }
        .company-panel-score.verdict-yes .score-main,
        .company-panel-score.verdict-yes .score-sub { color: var(--accent-green); }
        .company-panel-score.verdict-no {
            background: radial-gradient(circle at 0 0, rgba(248, 81, 73, 0.15), rgba(15, 23, 42, 1));
            border-color: rgba(248, 81, 73, 0.7);
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.8), 0 0 14px rgba(248, 81, 73, 0.35);
        }
        .company-panel-score.verdict-no .score-main,
        .company-panel-score.verdict-no .score-sub { color: var(--accent-red); }
        .company-panel-score h4 { color: var(--accent-amber); }

        .score-main { font-size: 1.05rem; font-weight: 600; color: #fefce8; }
        .score-sub { font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; color: rgba(248, 250, 252, 0.85); }
        .score-note { font-size: 0.78rem; color: var(--text-tertiary); margin-top: 4px; }

        .company-info-loading { text-align: center; padding: 30px; color: var(--text-secondary); }

        .retry-row { margin-top: 12px; display: flex; justify-content: flex-end; }

        .news-cell { max-width: 280px; font-size: 0.8125rem; color: var(--text-secondary); }
        .insider-badge { display: inline-block; padding: 3px 8px; border-radius: 999px; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; background: rgba(163, 113, 247, 0.18); color: var(--accent-purple); border: 1px solid rgba(163, 113, 247, 0.4); }

        .amount-cell { font-family: 'JetBrains Mono', monospace; color: var(--accent-green); font-weight: 500; }

        @media (max-width: 1024px) {
            .company-panels { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        @media (max-width: 768px) {
            .app-container { padding: 16px; }
            .input-grid { grid-template-columns: 1fr; }
            .button-row { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .date-row-container { flex-direction: column; align-items: center; }
            .company-panels { grid-template-columns: minmax(0, 1fr); }
        }

        /* === HEADER TITLE (replacing TH / Tracker Hub) === */
        .header-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.22em;
            text-transform: uppercase;
        }
        .header-title-part {
            background: linear-gradient(120deg, #e5e7eb, #60a5fa, #a855f7);
            -webkit-background-clip: text;
            color: transparent;
            opacity: 0.4;
            transition: opacity 0.2s ease-out, text-shadow 0.2s ease-out;
        }
        .header-title-separator {
            font-size: 0.95rem;
            color: rgba(148, 163, 184, 0.8);
        }
        /* Highlight current page using CSS :has() so JS stays untouched */
        body:has(#page-comparison.page.active) .header-title-dip {
            opacity: 1;
            text-shadow: 0 0 12px rgba(96, 165, 250, 0.6);
        }
        body:has(#page-comparison.page.active) .header-title-insider {
            opacity: 0.35;
        }
        body:has(#page-insider.page.active) .header-title-insider {
            opacity: 1;
            text-shadow: 0 0 12px rgba(96, 165, 250, 0.6);
        }
        body:has(#page-insider.page.active) .header-title-dip {
            opacity: 0.35;
        }

        /* === Insider page row styling tweaks === */
        #page-insider tbody tr {
            background-color: transparent !important;
        }
        #page-insider td {
            font-size: 0.875rem;
        }
        #page-insider .news-cell {
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        #page-insider .insider-badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(163, 113, 247, 0.26);
            color: #f4e9ff;
            border: 1px solid rgba(191, 148, 255, 0.9);
        }

        /* === Dim all button glows slightly === */
        .page-nav-tabs {
            box-shadow: 0 0 8px rgba(88, 166, 255, 0.18);
        }
        .page-nav-tab:hover {
            box-shadow: 0 0 6px rgba(88, 166, 255, 0.18);
        }
        .page-nav-tab.active {
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.26);
        }

        .btn-primary {
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.45), 0 0 8px rgba(56, 189, 248, 0.28);
        }
        .btn-primary:hover {
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.55), 0 0 10px rgba(56, 189, 248, 0.34);
        }
        .btn-secondary {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.6);
        }
        .btn-secondary:hover {
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.7);
        }
        .btn-purple {
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.45), 0 0 8px rgba(163, 113, 247, 0.30);
        }
        .btn-purple:hover {
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.52), 0 0 10px rgba(163, 113, 247, 0.34);
        }
    </style>
</head>
<body>
    <div class="top-gradient-bar"></div>
    <div class="app-container">
        <header class="nav-header">
            <div class="header-title">
                <span class="header-title-part header-title-dip">Dip Tracker</span>
                <span class="header-title-separator">/</span>
                <span class="header-title-part header-title-insider">Insider Tracker</span>
            </div>
        </header>

        <!-- DIP TRACKER PAGE -->
        <div id="page-comparison" class="page active">
            <div class="page-header">
                <h1 class="page-title">Dip Tracker</h1>
                <p class="page-subtitle">Parse, compare, and track buy-the-dip entries with real-time prices.</p>
            </div>
            <div class="input-grid">
                <div class="card input-full">
                    <div class="date-row-container">
                        <div class="date-picker-row">
                            <label for="dataDate">Data Date</label>
                            <input type="date" id="dataDate">
                        </div>
                        <div class="page-nav-tabs">
                            <button class="page-nav-tab active" id="nav1-comparison" onclick="showPage('comparison')">Dip Tracker</button>
                            <button class="page-nav-tab" id="nav1-insider" onclick="showPage('insider')">Insider Tracker</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <path d="M9 14l2 2 4-4"></path>
                            </svg>
                        </div>
                        <div>
                            <div class="card-title">Paste Dip Tracker Data</div>
                        </div>
                    </div>
                    <textarea id="rawTickerData" placeholder="Paste your CEO Watcher dip tracker data here..."></textarea>
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="parseData()">
                            <span>Parse Data</span>
                        </button>
                        <button class="btn btn-secondary" onclick="clearData()">
                            <span>Clear</span>
                        </button>
                        <button class="btn btn-purple" onclick="loadFromGoogleSheets()">
                            <span>Load From Sheet</span>
                        </button>
                    </div>
                    <div id="statusMessage" class="status-message"></div>
                </div>
            </div>

            <div class="results-card">
                <div class="results-header">
                    <div class="results-title">
                        <span>Parsed Results</span>
                    </div>
                    <div class="page-nav-tabs">
                        <button class="page-nav-tab active" id="nav2-comparison" onclick="showPage('comparison')">Dip Tracker</button>
                        <button class="page-nav-tab" id="nav2-insider" onclick="showPage('insider')">Insider Tracker</button>
                    </div>
                    <div class="results-count" id="rowCount">0 rows</div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Date</th>
                                <th>Ticker</th>
                                <th>Company</th>
                                <th>Alert Price</th>
                                <th>Current Price</th>
                                <th>% Change</th>
                                <th>Notes</th>
                                <th>Buy The Dip?</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <tr>
                                <td colspan="10">
                                    <div class="empty-state" id="emptyState">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <rect x="3" y="4" width="18" height="14" rx="2" ry="2"></rect>
                                            <path d="M3 10h18"></path>
                                            <path d="M8 15h2"></path>
                                        </svg>
                                        <p>No dip tracker rows parsed yet. Paste your data and click “Parse Data” to get started.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-success btn-small" onclick="saveToGoogleSheets()">Save to Sheet</button>
                        <button class="btn btn-secondary btn-small" onclick="refreshCurrentPrices()">Refresh Prices</button>
                    </div>
                    <button class="btn btn-retry btn-small" onclick="retryFailedCompanyInfo()">Retry Failed AI</button>
                </div>
            </div>
        </div>

        <!-- INSIDER TRACKER PAGE -->
        <div id="page-insider" class="page">
            <div class="page-header">
                <h1 class="page-title">Insider Tracker</h1>
                <p class="page-subtitle">Track insider buy signals from CEO Watcher alerts automatically.</p>
            </div>
            <div class="input-grid">
                <div class="card input-full">
                    <div class="date-row-container">
                        <div class="date-picker-row">
                            <label for="insiderDataDate">Data Date</label>
                            <input type="date" id="insiderDataDate">
                        </div>
                        <div class="page-nav-tabs">
                            <button class="page-nav-tab" id="nav1-comparison-insider" onclick="showPage('comparison')">Dip Tracker</button>
                            <button class="page-nav-tab active" id="nav1-insider-insider" onclick="showPage('insider')">Insider Tracker</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"></path>
                                <path d="M4 20c0-2.21 3.58-4 8-4s8 1.79 8 4"></path>
                            </svg>
                        </div>
                        <div>
                            <div class="card-title">Insider Trade Alerts</div>
                        </div>
                    </div>
                    <textarea id="rawInsiderData" placeholder="Paste your CEO Watcher insider alerts here..."></textarea>
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="parseInsiderData()">
                            <span>Parse Insider Data</span>
                        </button>
                        <button class="btn btn-secondary" onclick="clearInsiderData()">
                            <span>Clear</span>
                        </button>
                        <button class="btn btn-purple" onclick="loadInsiderFromGoogleSheets()">
                            <span>Load From Sheet</span>
                        </button>
                    </div>
                    <div id="insiderStatusMessage" class="status-message"></div>
                </div>
            </div>

            <div class="results-card">
                <div class="results-header">
                    <div class="results-title">
                        <span>Insider Results</span>
                    </div>
                    <div class="page-nav-tabs">
                        <button class="page-nav-tab" id="nav2-comparison-insider" onclick="showPage('comparison')">Dip Tracker</button>
                        <button class="page-nav-tab active" id="nav2-insider-insider" onclick="showPage('insider')">Insider Tracker</button>
                    </div>
                    <div class="results-count" id="insiderRowCount">0 rows</div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Date</th>
                                <th>Ticker</th>
                                <th>Company</th>
                                <th>News</th>
                                <th>Insider</th>
                                <th>Amount</th>
                                <th>Alert Price</th>
                                <th>Current</th>
                                <th>% Change</th>
                            </tr>
                        </thead>
                        <tbody id="insiderResultsBody">
                            <tr>
                                <td colspan="10">
                                    <div class="empty-state" id="insiderEmptyState">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <rect x="3" y="4" width="18" height="14" rx="2" ry="2"></rect>
                                            <path d="M3 10h18"></path>
                                            <path d="M8 15h2"></path>
                                        </svg>
                                        <p>No insider trades parsed yet. Paste your alerts and click “Parse Insider Data”.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-success btn-small" onclick="saveInsiderToGoogleSheets()">Save to Sheet</button>
                        <button class="btn btn-secondary btn-small" onclick="refreshInsiderCurrentPrices()">Refresh Prices</button>
                    </div>
                    <button class="btn btn-retry btn-small" onclick="exportInsiderCSV()">Export CSV</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const GOOGLE_SHEETS_ID = '19WB8SI3DBXKIeqyfGn2W2ihRLdI6_F5C0dhEucYSoNs';
        const GOOGLE_API_KEY = 'AIzaSyDzZYtdzU74EaBpYjo-e3kDdMaHmnN-2Uw';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw1zKzu5xhvWbLQ47vWMWbQpil3jb8n44nnbdlNoeLk0qMuqZrQO8uxJa2ANdOloe7aaBuVKz7QkJa7p/exec';

        let grokCache = {};
        let currentExpandedId = null; // Track which row is expanded
        let currentExpandedInsiderId = null; // Track which insider row is expanded

        const dateColors = [
            'rgba(56, 139, 253, 0.20)', 'rgba(46, 160, 67, 0.20)', 'rgba(137, 87, 229, 0.20)',
            'rgba(219, 171, 9, 0.20)', 'rgba(238, 87, 55, 0.20)', 'rgba(13, 170, 182, 0.20)',
            'rgba(191, 74, 142, 0.20)', 'rgba(96, 125, 217, 0.20)', 'rgba(204, 120, 50, 0.20)',
            'rgba(121, 184, 202, 0.20)', 'rgba(163, 113, 247, 0.20)', 'rgba(255, 123, 114, 0.20)',
            'rgba(125, 201, 145, 0.20)', 'rgba(255, 166, 87, 0.20)', 'rgba(149, 157, 239, 0.20)',
            'rgba(76, 165, 181, 0.20)', 'rgba(195, 132, 215, 0.20)', 'rgba(242, 144, 122, 0.20)',
            'rgba(162, 210, 143, 0.20)', 'rgba(255, 193, 94, 0.20)', 'rgba(137, 148, 255, 0.20)',
            'rgba(102, 181, 194, 0.20)', 'rgba(207, 153, 230, 0.20)', 'rgba(247, 163, 142, 0.20)',
            'rgba(172, 221, 154, 0.20)', 'rgba(255, 204, 112, 0.20)', 'rgba(157, 168, 255, 0.20)',
            'rgba(112, 191, 204, 0.20)', 'rgba(217, 163, 240, 0.20)', 'rgba(255, 173, 152, 0.20)'
        ];

        let parsedData = [], rowIdCounter = 0, insiderData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('dataDate').value = new Date().toISOString().split('T')[0];
            await loadGrokCache();
            await loadFromGoogleSheets();
        });

        function showStatus(msg, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = 'status-message status-' + type;
            setTimeout(() => el.className = 'status-message', 5000);
        }
        function showInsiderStatus(msg, type) {
            const el = document.getElementById('insiderStatusMessage');
            el.textContent = msg;
            el.className = 'status-message status-' + type;
            setTimeout(() => el.className = 'status-message', 5000);
        }

        // ===== API CALLS VIA APPS SCRIPT =====
        async function apiCall(action, data = {}) {
            try {
                const res = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...data })
                });
                if (!res.ok) throw new Error('Network response was not ok');
                const json = await res.json();
                if (json.error) throw new Error(json.error);
                return json;
            } catch (err) {
                console.error(`API Error [${action}]`, err);
                throw err;
            }
        }

        async function loadGrokCache() {
            try {
                const cached = localStorage.getItem('grokCache');
                if (cached) grokCache = JSON.parse(cached);
            } catch (e) {
                console.warn('Could not load grok cache from localStorage', e);
            }
        }

        function saveGrokCache() {
            try {
                localStorage.setItem('grokCache', JSON.stringify(grokCache));
            } catch (e) {
                console.warn('Could not save grok cache to localStorage', e);
            }
        }

        async function getGrokAnalysis(ticker, forceRefresh = false) {
            const key = ticker.toUpperCase();
            if (!forceRefresh && grokCache[key]) return grokCache[key];

            const data = await apiCall('getGrokAnalysis', { ticker });
            if (!data || data.error) return data;

            grokCache[key] = data;
            saveGrokCache();
            return data;
        }

        async function getCompanyInfo(ticker) {
            return apiCall('getCompanyInfo', { ticker });
        }

        async function loadFromGoogleSheets() {
            try {
                const data = await apiCall('loadDipTracker');
                parsedData = (data.rows || []).map(row => ({
                    ...row,
                    id: ++rowIdCounter
                }));
                renderTable();
                showStatus(`Loaded ${parsedData.length} rows from sheet.`, 'success');
            } catch (err) {
                console.error(err);
                showStatus('Error loading from sheet.', 'error');
            }
        }

        async function saveToGoogleSheets() {
            if (!parsedData.length) {
                showStatus('No data to save.', 'error');
                return;
            }
            try {
                await apiCall('saveDipTracker', { rows: parsedData });
                showStatus('Saved to sheet.', 'success');
            } catch (err) {
                console.error(err);
                showStatus('Error saving to sheet.', 'error');
            }
        }

        async function refreshCurrentPrices() {
            if (!parsedData.length) {
                showStatus('No data to refresh.', 'error');
                return;
            }
            try {
                const data = await apiCall('refreshDipPrices', { rows: parsedData });
                parsedData = (data.rows || []).map(row => ({
                    ...row,
                    id: row.id || ++rowIdCounter
                }));
                renderTable();
                showStatus('Refreshed current prices.', 'success');
            } catch (err) {
                console.error(err);
                showStatus('Error refreshing prices.', 'error');
            }
        }

        async function retryFailedCompanyInfo() {
            const failed = parsedData.filter(row => !row.companyInfo || row.companyInfo.error);
            if (!failed.length) {
                showStatus('No failed AI rows to retry.', 'info');
                return;
            }
            showStatus('Retrying AI analysis for failed rows...', 'info');

            for (const row of failed) {
                try {
                    const info = await getCompanyInfo(row.ticker);
                    row.companyInfo = info;
                } catch (err) {
                    console.error('Error retrying company info for', row.ticker, err);
                }
            }

            renderTable();
            showStatus('Retried AI analysis for failed rows.', 'success');
        }

        async function retryFailedInsiderCompanyInfo() {
            const failed = insiderData.filter(row => !row.companyInfo || row.companyInfo.error);
            if (!failed.length) {
                showInsiderStatus('No failed AI rows to retry.', 'info');
                return;
            }
            showInsiderStatus('Retrying AI analysis for insider rows...', 'info');

            for (const row of failed) {
                try {
                    const info = await getCompanyInfo(row.ticker);
                    row.companyInfo = info;
                } catch (err) {
                    console.error('Error retrying insider company info for', row.ticker, err);
                }
            }

            renderInsiderTable();
            showInsiderStatus('Retried AI analysis for insider rows.', 'success');
        }

        // ===== DIP TRACKER PARSING & RENDERING =====
        function parseData() {
            const raw = document.getElementById('rawTickerData').value.trim();
            const date = document.getElementById('dataDate').value;
            if (!raw) {
                showStatus('Please paste some data first.', 'error');
                return;
            }
            if (!date) {
                showStatus('Please select a data date.', 'error');
                return;
            }

            const rows = [];
            const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);

            for (const line of lines) {
                const parts = line.split('\t');
                if (parts.length < 4) continue;
                const [ticker, companyName, alertPriceStr, notes] = parts;
                const alertPrice = parseFloat(alertPriceStr.replace(/[^0-9.]/g, '')) || null;

                rows.push({
                    id: ++rowIdCounter,
                    date,
                    ticker: ticker.toUpperCase(),
                    companyName: companyName || '',
                    alertPrice,
                    currentPrice: null,
                    notes: notes || '',
                    buyTheDip: '',
                    companyInfo: null
                });
            }

            if (!rows.length) {
                showStatus('No valid rows found in pasted data.', 'error');
                return;
            }

            parsedData = rows;
            renderTable();
            showStatus(`Parsed ${rows.length} rows successfully.`, 'success');
        }

        function clearData() {
            parsedData = [];
            document.getElementById('rawTickerData').value = '';
            renderTable();
            showStatus('Cleared.', 'info');
        }

        function getDateColor(dateStr) {
            if (!dateStr) return 'transparent';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return 'transparent';

            const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const index = dayOfYear % dateColors.length;
            return dateColors[index];
        }

        function toggleCompanyInfo(id) {
            currentExpandedId = currentExpandedId === id ? null : id;
            renderTable();
        }

        function toggleInsiderCompanyInfo(id) {
            currentExpandedInsiderId = currentExpandedInsiderId === id ? null : id;
            renderInsiderTable();
        }

        function renderCompanyInfo(item) {
            const info = item.companyInfo;
            if (!info || info.error) {
                return `
                    <div class="company-info-layout">
                        <div class="company-hero">
                            <div class="company-hero-main">
                                <div class="company-hero-ticker">${item.ticker}</div>
                                <div class="company-hero-name">${item.companyName || 'Unknown Company'}</div>
                            </div>
                            <div class="company-hero-meta">
                                <span class="company-hero-chip">Sector: N/A</span>
                                <span class="company-hero-chip">Industry: N/A</span>
                                <span class="company-hero-chip">Market Cap: N/A</span>
                            </div>
                        </div>
                        <div class="company-panels">
                            <div class="company-panel company-panel-snapshot">
                                <h4>Snapshot</h4>
                                <p>No AI analysis available yet for this ticker.</p>
                            </div>
                            <div class="company-panel company-panel-score">
                                <h4>Buy The Dip?</h4>
                                <div class="score-main">WAIT</div>
                                <div class="score-sub">—</div>
                                <div class="score-note">Once AI analysis is available, this section will show a confidence-backed verdict.</div>
                            </div>
                            <div class="company-panel company-panel-bottomline">
                                <h4>Bottom Line</h4>
                                <p>We don’t have enough data yet to make an informed call on this dip.</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            const snapshotText = info.grokWhatItDoes || info.description || 'No description available.';
            const bottomlineText = info.grokBottomLine || 'AI bottom line not yet available for this ticker.';
            const verdictRaw = info.grokBuyTheDip || '';

            let verdict = 'Wait';
            let percent = '—';
            let verdictClass = '';

            if (verdictRaw) {
                const match = verdictRaw.match(/(Yes|No|Maybe|Wait)[^\d]*([\d]{1,3})%/i);
                if (match) {
                    verdict = match[1].toUpperCase();
                    percent = match[2] + '%';
                }
                if (verdict === 'YES') verdictClass = 'verdict-yes';
                else if (verdict === 'NO') verdictClass = 'verdict-no';
            }

            const link = info.companyUrl ? `<a href="${info.companyUrl}" target="_blank" rel="noopener noreferrer">Open company overview ↗</a>` : '';

            return `
                <div class="company-info-layout">
                    <div class="company-hero">
                        <div class="company-hero-main">
                            <div class="company-hero-ticker">${item.ticker}</div>
                            <div class="company-hero-name">${item.companyName}</div>
                        </div>
                        <div class="company-hero-meta">
                            <span class="company-hero-chip">Sector: ${info.sector || info.grokSector || '—'}</span>
                            <span class="company-hero-chip">Industry: ${info.industry || '—'}</span>
                            <span class="company-hero-chip">Market Cap: ${info.marketCap || '—'}</span>
                        </div>
                    </div>
                    <div class="company-panels">
                        <div class="company-panel company-panel-snapshot">
                            <h4>Snapshot</h4>
                            <p>${snapshotText}</p>
                            ${link}
                        </div>
                        <div class="company-panel company-panel-score ${verdictClass}">
                            <h4>Buy The Dip?</h4>
                            <div class="score-main">${verdict}</div>
                            <div class="score-sub">${percent} confidence</div>
                            <div class="score-note">${info.grokScoreNote || 'Based on recent price action, sector context, and company fundamentals.'}</div>
                        </div>
                        <div class="company-panel company-panel-bottomline">
                            <h4>Bottom Line</h4>
                            <p>${bottomlineText}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTable() {
            const tbody = document.getElementById('resultsBody');
            const emptyState = document.getElementById('emptyState');
            const rowCount = document.getElementById('rowCount');

            rowCount.textContent = `${parsedData.length} rows`;

            if (!parsedData.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10">
                            <div class="empty-state" id="emptyState">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="4" width="18" height="14" rx="2" ry="2"></rect>
                                    <path d="M3 10h18"></path>
                                    <path d="M8 15h2"></path>
                                </svg>
                                <p>No dip tracker rows parsed yet. Paste your data and click “Parse Data” to get started.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            emptyState.style.display = 'none';

            tbody.innerHTML = parsedData.map((item, index) => {
                const rowColor = getDateColor(item.date);
                const hasCompanyInfo = item.companyInfo && !item.companyInfo.error;
                const change = item.alertPrice && item.currentPrice
                    ? ((item.currentPrice - item.alertPrice) / item.alertPrice) * 100
                    : null;
                const changeClass = change !== null ? (change >= 0 ? 'change-positive' : 'change-negative') : '';
                const changeText = change !== null ? `${change >= 0 ? '+' : ''}${change.toFixed(2)}%` : '—';
                const currentPriceClass = item.currentPrice && item.alertPrice
                    ? (item.currentPrice >= item.alertPrice ? 'price-positive' : 'price-negative')
                    : '';

                const isExpanded = currentExpandedId === item.id;

                let html = `<tr style="background-color: ${rowColor};">
                    <td>${index + 1}</td>
                    <td>${item.date}</td>
                    <td class="ticker-cell ${isExpanded ? 'expanded' : ''}" onclick="toggleCompanyInfo(${item.id})">${item.ticker}</td>
                    <td>${item.companyName}</td>
                    <td class="price-cell">${item.alertPrice != null ? '$' + item.alertPrice.toFixed(2) : '—'}</td>
                    <td class="price-cell ${currentPriceClass}">${item.currentPrice != null ? '$' + item.currentPrice.toFixed(2) : '<span class="loading"></span>'}</td>
                    <td class="${changeClass}">${changeText}</td>
                    <td>${item.notes || '—'}</td>
                    <td>${item.buyTheDip || '—'}</td>
                    <td><button class="btn-remove" onclick="removeRow(${item.id})">✕</button></td>
                </tr>`;

                if (isExpanded) {
                    html += `<tr class="company-info-row">
                        <td colspan="10">
                            <div class="company-info-content">
                                ${hasCompanyInfo
                                    ? renderCompanyInfo(item)
                                    : '<div class="company-info-loading"><span class="loading"></span> Loading AI analysis...</div>'}
                            </div>
                        </td>
                    </tr>`;
                }

                return html;
            }).join('');
        }

        function removeRow(id) {
            parsedData = parsedData.filter(row => row.id !== id);
            if (currentExpandedId === id) currentExpandedId = null;
            renderTable();
        }

        // ===== INSIDER TRACKER =====
        async function loadInsiderFromGoogleSheets() {
            try {
                const data = await apiCall('loadInsiderTracker');
                insiderData = (data.rows || []).map(row => ({
                    ...row,
                    id: row.id || ++rowIdCounter
                }));
                renderInsiderTable();
                showInsiderStatus(`Loaded ${insiderData.length} rows from sheet.`, 'success');
            } catch (err) {
                console.error(err);
                showInsiderStatus('Error loading insider data from sheet.', 'error');
            }
        }

        async function saveInsiderToGoogleSheets() {
            if (!insiderData.length) {
                showInsiderStatus('No data to save.', 'error');
                return;
            }
            try {
                await apiCall('saveInsiderTracker', { rows: insiderData });
                showInsiderStatus('Saved insider data to sheet.', 'success');
            } catch (err) {
                console.error(err);
                showInsiderStatus('Error saving insider data.', 'error');
            }
        }

        async function refreshInsiderCurrentPrices() {
            if (!insiderData.length) {
                showInsiderStatus('No insider data to refresh.', 'error');
                return;
            }
            try {
                const data = await apiCall('refreshInsiderPrices', { rows: insiderData });
                insiderData = (data.rows || []).map(row => ({
                    ...row,
                    id: row.id || ++rowIdCounter
                }));
                renderInsiderTable();
                showInsiderStatus('Refreshed insider current prices.', 'success');
            } catch (err) {
                console.error(err);
                showInsiderStatus('Error refreshing insider prices.', 'error');
            }
        }

        function parseInsiderData() {
            const raw = document.getElementById('rawInsiderData').value.trim();
            const date = document.getElementById('insiderDataDate').value;
            if (!raw) {
                showInsiderStatus('Please paste some insider alert data first.', 'error');
                return;
            }
            if (!date) {
                showInsiderStatus('Please select a data date.', 'error');
                return;
            }

            const rows = [];
            const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);

            for (const line of lines) {
                const parts = line.split('\t');
                if (parts.length < 5) continue;

                const [ticker, companyName, news, insider, amountRaw, alertPriceRaw] = parts;
                const amount = amountRaw || '';
                const alertPrice = parseFloat((alertPriceRaw || '').replace(/[^0-9.]/g, '')) || null;

                rows.push({
                    id: ++rowIdCounter,
                    date,
                    ticker: ticker.toUpperCase(),
                    companyName: companyName || '',
                    news: news || '',
                    insider: insider || '',
                    amount,
                    alertPrice,
                    currentPrice: null,
                    companyInfo: null
                });
            }

            if (!rows.length) {
                showInsiderStatus('No valid insider rows found in pasted data.', 'error');
                return;
            }

            insiderData = rows;
            renderInsiderTable();
            showInsiderStatus(`Parsed ${rows.length} insider trades.`, 'success');
        }

        function clearInsiderData() {
            insiderData = [];
            document.getElementById('rawInsiderData').value = '';
            renderInsiderTable();
            showInsiderStatus('Cleared.', 'info');
        }

        function renderInsiderCompanyInfo(item) {
            const info = item.companyInfo;
            if (!info || info.error) {
                return `
                    <div class="company-info-layout">
                        <div class="company-hero">
                            <div class="company-hero-main">
                                <div class="company-hero-ticker">${item.ticker}</div>
                                <div class="company-hero-name">${item.companyName || 'Unknown Company'}</div>
                            </div>
                            <div class="company-hero-meta">
                                <span class="company-hero-chip">Sector: N/A</span>
                                <span class="company-hero-chip">Industry: N/A</span>
                                <span class="company-hero-chip">Market Cap: N/A</span>
                            </div>
                        </div>
                        <div class="company-panels">
                            <div class="company-panel company-panel-snapshot">
                                <h4>Snapshot</h4>
                                <p>No AI analysis available yet for this ticker.</p>
                            </div>
                            <div class="company-panel company-panel-score">
                                <h4>Buy The Dip?</h4>
                                <div class="score-main">WAIT</div>
                                <div class="score-sub">—</div>
                                <div class="score-note">Once AI analysis is available, this section will show a confidence-backed verdict.</div>
                            </div>
                            <div class="company-panel company-panel-bottomline">
                                <h4>Bottom Line</h4>
                                <p>We don’t have enough data yet to make an informed call on this insider signal.</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            const snapshotText = info.grokWhatItDoes || info.description || 'No description available.';
            const bottomlineText = info.grokBottomLine || 'AI bottom line not yet available for this ticker.';
            const verdictRaw = info.grokBuyTheDip || '';

            let verdict = 'Wait';
            let percent = '—';
            let verdictClass = '';

            if (verdictRaw) {
                const match = verdictRaw.match(/(Yes|No|Maybe|Wait)[^\d]*([\d]{1,3})%/i);
                if (match) {
                    verdict = match[1].toUpperCase();
                    percent = match[2] + '%';
                }
                if (verdict === 'YES') verdictClass = 'verdict-yes';
                else if (verdict === 'NO') verdictClass = 'verdict-no';
            }

            const link = info.companyUrl ? `<a href="${info.companyUrl}" target="_blank" rel="noopener noreferrer">Open company overview ↗</a>` : '';

            return `
                <div class="company-info-layout">
                    <div class="company-hero">
                        <div class="company-hero-main">
                            <div class="company-hero-ticker">${item.ticker}</div>
                            <div class="company-hero-name">${item.companyName}</div>
                        </div>
                        <div class="company-hero-meta">
                            <span class="company-hero-chip">Sector: ${info.sector || info.grokSector || '—'}</span>
                            <span class="company-hero-chip">Industry: ${info.industry || '—'}</span>
                            <span class="company-hero-chip">Market Cap: ${info.marketCap || '—'}</span>
                        </div>
                    </div>
                    <div class="company-panels">
                        <div class="company-panel company-panel-snapshot">
                            <h4>Snapshot</h4>
                            <p>${snapshotText}</p>
                            ${link}
                        </div>
                        <div class="company-panel company-panel-score ${verdictClass}">
                            <h4>Buy The Dip?</h4>
                            <div class="score-main">${verdict}</div>
                            <div class="score-sub">${percent} confidence</div>
                            <div class="score-note">${info.grokScoreNote || 'Based on recent price action, sector context, and fundamentals.'}</div>
                        </div>
                        <div class="company-panel company-panel-bottomline">
                            <h4>Bottom Line</h4>
                            <p>${bottomlineText}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInsiderTable() {
            const tbody = document.getElementById('insiderResultsBody');
            const emptyState = document.getElementById('insiderEmptyState');
            const rowCount = document.getElementById('insiderRowCount');

            rowCount.textContent = `${insiderData.length} rows`;

            if (!insiderData.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10">
                            <div class="empty-state" id="insiderEmptyState">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="4" width="18" height="14" rx="2" ry="2"></rect>
                                    <path d="M3 10h18"></path>
                                    <path d="M8 15h2"></path>
                                </svg>
                                <p>No insider trades parsed yet. Paste your alerts and click “Parse Insider Data”.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            emptyState.style.display = 'none';

            tbody.innerHTML = insiderData.map((item, index) => {
                const hasCompanyInfo = item.companyInfo && !item.companyInfo.error;
                const change = item.alertPrice && item.currentPrice
                    ? ((item.currentPrice - item.alertPrice) / item.alertPrice) * 100
                    : null;
                const changeClass = change !== null ? (change >= 0 ? 'change-positive' : 'change-negative') : '';
                const changeText = change !== null ? `${change >= 0 ? '+' : ''}${change.toFixed(2)}%` : '—';
                const currentPriceClass = item.currentPrice && item.alertPrice
                    ? (item.currentPrice >= item.alertPrice ? 'price-positive' : 'price-negative')
                    : '';

                const isExpanded = currentExpandedInsiderId === item.id;

                let html = `<tr>
                    <td>${index + 1}</td>
                    <td>${item.date}</td>
                    <td class="ticker-cell ${isExpanded ? 'expanded' : ''}" onclick="toggleInsiderCompanyInfo(${item.id})">${item.ticker}</td>
                    <td>${item.companyName}</td>
                    <td class="news-cell">${item.news}</td>
                    <td>${item.insider ? `<span class="insider-badge">${item.insider}</span>` : '—'}</td>
                    <td class="amount-cell">${item.amount || '—'}</td>
                    <td class="price-cell">${item.alertPrice != null ? '$' + item.alertPrice.toFixed(2) : '—'}</td>
                    <td class="price-cell ${currentPriceClass}">${item.currentPrice != null ? '$' + item.currentPrice.toFixed(2) : '<span class="loading"></span>'}</td>
                    <td class="${changeClass}">${changeText}</td>
                </tr>`;

                if (isExpanded) {
                    html += `<tr class="company-info-row">
                        <td colspan="10">
                            <div class="company-info-content">
                                ${hasCompanyInfo
                                    ? renderInsiderCompanyInfo(item)
                                    : '<div class="company-info-loading"><span class="loading"></span> Loading AI analysis...</div>'}
                            </div>
                        </td>
                    </tr>`;
                }

                return html;
            }).join('');
        }

        function exportInsiderCSV() {
            if (!insiderData.length) {
                showInsiderStatus('No data to export.', 'error');
                return;
            }

            const headers = ['#', 'Date', 'Ticker', 'Company', 'News', 'Insider', 'Amount', 'Alert Price', 'Current', '% Change'];
            const rows = insiderData.map((item, index) => {
                const change = item.alertPrice && item.currentPrice
                    ? ((item.currentPrice - item.alertPrice) / item.alertPrice) * 100
                    : null;
                const changeText = change !== null ? `${change >= 0 ? '+' : ''}${change.toFixed(2)}%` : '';

                return [
                    index + 1,
                    item.date,
                    item.ticker,
                    `"${item.companyName || ''}"`,
                    `"${(item.news || '').replace(/"/g, '""')}"`,
                    `"${item.insider || ''}"`,
                    item.amount || '',
                    item.alertPrice || '',
                    item.currentPrice || '',
                    changeText
                ].join(',');
            });

            const csvContent = [headers.join(','), ...rows].join('\n');
            downloadCSV(csvContent, 'insider_trades');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename + '.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ===== PAGE NAVIGATION =====
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            document.querySelectorAll('.page-nav-tab').forEach(t => t.classList.remove('active'));
            if (page === 'comparison') {
                document.getElementById('nav1-comparison').classList.add('active');
                document.getElementById('nav2-comparison').classList.add('active');
                document.getElementById('nav1-comparison-insider').classList.add('active');
                document.getElementById('nav2-comparison-insider').classList.add('active');
            } else {
                document.getElementById('nav1-insider').classList.add('active');
                document.getElementById('nav2-insider').classList.add('active');
                document.getElementById('nav1-insider-insider').classList.add('active');
                document.getElementById('nav2-insider-insider').classList.add('active');
            }
            if (page === 'insider') loadInsiderData();
        }

        async function loadInsiderData() {
            if (insiderData.length) return;
            try {
                const data = await apiCall('loadInsiderTracker');
                insiderData = (data.rows || []).map(row => ({
                    ...row,
                    id: row.id || ++rowIdCounter
                }));
                renderInsiderTable();
                showInsiderStatus(`Loaded ${insiderData.length} insider rows from sheet.`, 'success');
            } catch (err) {
                console.error(err);
                showInsiderStatus('Error loading insider data from sheet.', 'error');
            }
        }
    </script>
</body>
</html>
